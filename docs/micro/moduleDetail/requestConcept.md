# 请求概念篇

请求模块主要实现了如下功能：

* 请求实例注册
* 请求拦截
    - 请求头携带 token
    - 登录过期跳转登录页
* 响应拦截
    - 登录过期处理
    - 错误码处理
    - 错误消息统一提示
* 代理配置（跨域）
* 接口 api 快捷配置注册

本章概念依旧是为想要学习请求封装的同学准备的

框架内已对请求模块进行了高度封装，各位开发人员即使对内部封装不了解，知道如何去注册 api，如何[使用 api ](./requestPractical.md#api-的使用)也是可以正常开发的

框架的请求工具使用的是 [axios](http://www.axios-js.com/)

基座应用的封装和微应用的实现不一样，微应用的属于简化版

## 请求实例封装

### 基座应用

模块内容如下：

![基座请求模块](/images/realize/基座请求模块.png)

:::tip

整个系统（基座应用，微应用）的请求模块核心都在这里

:::

#### index.ts

* 创建当前系统的 axios 实例
* 当前系统的配置传递
* 请求拦截器添加
* 响应拦截器添加
* 抛出实例

#### constant

`/src/http/constant/` 目录用来存放一些请求模块运行时的常量信息

内部已经包含一个 `excludeApis.ts` ，用来存放不需要验证登录的接口标识

#### interceptors

路由拦截器处理函数模块，之所以将拦截器的处理函数独立出来，是因为要统一拦截器的行为，抽取成模块，才能传递给微应用，以让微应用使用基座应用的拦截处理函数

* request.ts 请求拦截器处理函数

    - 1. 判断当期请求是否需要验证登录
        > 否 -> 放行；<br/>
        > 是 -> 如下

    - 2. 添加 token 到请求头中，统一处理
    - 3. 验证登录是否超时或刷新（阻塞行为）
        > 未超时 -> 放行；<br/>
        > 刷新后 -> 将刷新接口返回的新的 token 更新请求头中已添加的 token；<br/>
        > 超时 -> 放弃请求，返回登录页

* response.ts 响应拦截器处理函数

    - 1. 判断此次请求是否为业务请求（需要登录）
        > 否 -> 放行；<br/>
        > 是 -> 如下

    - 2. 是否返回登录失效状态码
        > 是 -> 清空登录信息 + 返回登录页 + 消息提示（warning）；<br/>
        > 否 -> 如下

    - 3. 请求是否成功（状态码 === '000000'）
        > 否 -> 返回结果 + 消息提示（error）；<br/>
        > 是 -> 如下

    - 4. 返回响应体

#### proxys 

proxys 模块是用来配置代理的，将为 webpack 服务，为了统一请求模块，故将代理也放在了 `/src/http` 下

何为代理？

为了解决跨域问题，代理是通过我们开发模式下的本地开发服务器，作为中间服务器，进行代理转发的一个过程

我们开发模式下，发送的请求实际上都是请求的本地开发服务器的，详细请参考 [vue-cli devServer.proxy](https://cli.vuejs.org/zh/config/#devserver-proxy)

代理模块内容，将被 webpack 静态加载，所以都要以 js 文件编写

:::tip

基座应用在运行时，将微应用的资源加载到自己的端口下，进行解析渲染，就造成微应用中的请求实际上也是向基座应用的端口去请求的，所以，代理的配置都要由基座应用统一完成

:::

* index.js
    > 统一抛出各应用的代理配置

* readEnvConfig.js
    > 属于工具类，读取 `/.env` 或 `/.env.local` 的默认代理 url 配置

* uums.js
    > uums 系统的代理配置

* xxx.js

#### utils.ts

http 模块的工具类

### 微应用

微应用 http 的封装和基座应用的 `/src/http/index.ts` 功能一致，存放与 `/src/utils/http.ts`
